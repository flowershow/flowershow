name: E2E Tests

# Required secrets:
# - GH_ACCESS_TOKEN: GitHub Personal Access Token with repo scope
#   Used for GitHub API operations during E2E tests
#   Must have access to the e2e test repository

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

jobs:
  test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start MinIO Server
        run: |
          mkdir -p ~/minio/data
          docker run \
            -d \
            -p 9000:9000 \
            -p 9001:9001 \
            --name minio1 \
            -v ~/minio/data:/data \
            -e "MINIO_ROOT_USER=minioadmin" \
            -e "MINIO_ROOT_PASSWORD=minioadmin" \
            quay.io/minio/minio server /data --console-address ":9001"
          # Wait for MinIO to be ready
          timeout 60s bash -c 'until curl -sf http://localhost:9000/minio/health/live; do sleep 1; done'

      - name: Configure MinIO bucket
        run: |
          pip install minio
          python3 - <<EOF
          from minio import Minio
          client = Minio(
              "localhost:9000",
              access_key="minioadmin",
              secret_key="minioadmin",
              secure=False
          )
          if not client.bucket_exists("datahub"):
              client.make_bucket("datahub")
              client.set_bucket_policy(
                  "datahub",
                  '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"AWS":["*"]},"Action":["s3:GetObject"],"Resource":["arn:aws:s3:::datahub/*"]}]}'
              )
          EOF

      - name: Create env file from example
        run: |
          cp .env.example .env
          # Update required values for e2e testing
          sed -i 's|postgresql://postgres@localhost:5432/<database-name>?schema=public|postgresql://postgres:postgres@localhost:5432/datahub_test?schema=public|g' .env
          sed -i 's|^NEXT_PUBLIC_AUTH_GITHUB_ID=.*|NEXT_PUBLIC_AUTH_GITHUB_ID=test-github-id|' .env
          sed -i 's|^AUTH_GITHUB_SECRET=.*|AUTH_GITHUB_SECRET=test-github-secret|' .env
          sed -i 's|^GH_ACCESS_TOKEN=.*|GH_ACCESS_TOKEN=\${{ secrets.GH_ACCESS_TOKEN }}|' .env

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Push database schema
        run: npx prisma db push

      - name: Configure hosts
        run: |
          echo "127.0.0.1 cloud.localhost" | sudo tee -a /etc/hosts

      - name: Fetch app config
        run: node scripts/fetch-app-config.mjs

      - name: Start Next.js app
        run: |
          pnpm dev &
          # Wait for Next.js to be ready by polling the health endpoint
          timeout 60s bash -c 'until curl -sf http://cloud.localhost:3000; do sleep 2; done'

      - name: Start Inngest
        run: |
          npx inngest-cli@latest dev --no-discovery -u http://localhost:3000/api/inngest &
          sleep 5

      - name: Run Playwright tests
        run: npx playwright test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 30
